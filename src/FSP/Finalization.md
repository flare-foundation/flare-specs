# Finalization
Finalization is the process by which the results of a round of an enshrined protocol are confirmed on the network. Once finalized, the Merkle root containing the results of the round can be used as input to transactions on the network. Finalization of a voting round for a protocol is done on the Relay contract through the relay function:
```Solidity
function relay() external returns (bytes memory);
```
The finalization transaction input contains the relay function selector (4 bytes), followed by an encoded [Finalization](/src/FSP/Encoding.md#finalization) message. After a successful finalization a response is emitted as follows:
```Solidity
event ProtocolMessageRelayed(
 uint8 indexed protocolId,
 uint32 indexed votingRoundId,
 bool isSecureRandom,
 bytes32 merkleRoot
);
```

## Finalizer Selection
In each round of each protocol, a random selection of entities are chosen to participate in early finalization, during a window known as the _grace period_. Only selected providers receive rewards for submitting a finalization transaction in this window. If no provider submits a valid finalization transaction in this window, the first provider to do so after the window ends receives the rewards instead. 

Providers are selected to participate in early finalization in a random process, selected sequentially and independently with probability equivalent to their signing weight until more than $5\%$ of the total weight of providers has been selected. The results of this sampling are available in advance, so that providers know whether or not they have been selected for finalization before the round begins. 

The random selection starts from a random seed $\mathrm{seed}= \mathrm{uint}256(\mathrm{initialSeed})$ that is known to all providers and an empty set of provider indexes $S$. Let $W$ be the total signing weight in the active signing policy and let $t = W \cdot 0.05$. Each entity has an index $i$ and signing weight $W_{i, \mathrm{sign}}$ assigned by the signing policy. Define $T(i) = \sum_{j = 0}^i W_{i, \mathrm{sign}}$. The selection proceeds as follows:

1. Set $x = \mathrm{seed} \mod W$. Let $i$ be the smallest integer such that $x \leq T(i)$. If $i \notin S$, add $i$ to $S$ and update $\mathrm{seed} := \mathrm{keccak}255(\mathrm{seed})$.
2. If $\sum_{i  \in S} W_{i, \mathrm{sign}} \geq t$, return $S$.
3. Otherwise, return to step 1. 

The entities whose indexes are in $S$ are precisely those who are rewarded for finalizing during the grace period.

### Seed Selection
To select the providers as above, an initial random seed, known to all providers, is required.  The precise seed is the hash of the random seed generated by the FTSO protocol for the signing policy together with the protocol and voting round IDs, a $32$ byte hex string that is computed by solidity code:
```solidity
bytes32 initialSeed = keccak256(abi.encode(signingPolicySeed,protocolID,votingRoundID));
```
where protocolID is of type $\mathrm{uint}8$, votingRoundID is $\mathrm{uint}32$, and
where signingPolicySeed is a \mathrm{uint}256$ value as emitted in the seed field of `SigningPolicyInitialized` event for the signing policy active in the current voting round. 

### Threshold
The threshold value $t$ is set in the signing policy, and is set to $5\%$ of the total signing weight. In the unlikely case where a round is started on one signing policy but expected to be rewarded in another, it is raised by one fifth to $12 * t /10$.

Formally, let $v$ be the votingRoundID of the message being finalized, $r$ be the ID of current active signingPolicy, $\mathrm{expected}(v)$ be the [expected reward epoch](Epochs.md#reward-epoch) for $v$, and $x$ be the ID of the last initialized signingPolicy. If $\mathrm{expected}(v) = r$ the threshold is the usual $5\%$. If $\mathrm{expected}(v) > r$ and $x=r$, the threshold is increased. 

## Rewarding
Each protocol has designated funds to incentivize fast finalization. The value of the rewards can vary per protocol and voting round. Let $V(i)$ be the total designated rewards for a protocol in voting round $i$ and $S(i)$ the number of selected providers to finalize during the grace period in the round (e.g. the size of the set $S$ of selected providers).

### During the Grace Period
In each round, the selected entity is rewarded if they make a transaction from signingPolicyAddress inside the grace period that either:
- finalizes the protocol for the round.
- would finalize the protocol for the round but the protocol is already finalized. 

Each entity completing such a transaction receives an equal share $\dfrac{V(i)}{S(i)}$, with a proportion shared among their delegators as usual. If a selected entity does not make such a transaction, their portion gets burned.

### Outside the Grace Period
If finalization does not happen inside the grace period, the first address that successfully submits a transaction after the grace period ends that finalizes the protocol for the round gets the whole reward $V(i)$.